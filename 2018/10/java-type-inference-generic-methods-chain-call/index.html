<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Szymon Stepniak"><title>Java 8 type inference in generic methods chain call - what might go wrong?</title><meta name="description" content="Yesterday I have found this interesting question on Stack Overflow asked by Opal. He faced some unexpected compilation errors when dealing with Java generics and Vavr library. It turned out the root cause of the issue there was not the library, but Jav..."><link rel="alternate" type="application/rss+xml" title="e.printStackTrace(); // Blog" href="/atom.xml"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.13.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=18"><link rel="stylesheet" href="/css/conum.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700"><meta name="description" content="Yesterday I have found this interesting question on Stack Overflow asked by Opal. He faced some unexpected compilation errors when dealing with Java generics and Vavr library. It turned out the root c"><meta name="keywords" content="java,java-8,java-generics,type-inference,jsr335,jep101"><meta property="og:type" content="article"><meta property="og:title" content="Java 8 type inference in generic methods chain call - what might go wrong?"><meta property="og:url" content="https://e.printstacktrace.blog/2018/10/java-type-inference-generic-methods-chain-call/index.html"><meta property="og:site_name" content="e.printStackTrace(); &#x2F;&#x2F; Blog"><meta property="og:description" content="Yesterday I have found this interesting question on Stack Overflow asked by Opal. He faced some unexpected compilation errors when dealing with Java generics and Vavr library. It turned out the root c"><meta property="og:locale" content="en"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/java-generics-type-inference.jpg"><meta property="og:updated_time" content="2018-10-28T05:50:57.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Java 8 type inference in generic methods chain call - what might go wrong?"><meta name="twitter:description" content="Yesterday I have found this interesting question on Stack Overflow asked by Opal. He faced some unexpected compilation errors when dealing with Java generics and Vavr library. It turned out the root c"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/java-generics-type-inference.jpg"><meta name="twitter:creator" content="@wololock"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://e.printstacktrace.blog/2018/10/java-type-inference-generic-methods-chain-call/"},"headline":"Java 8 type inference in generic methods chain call - what might go wrong?","image":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/og/java-generics-type-inference.jpg"},"datePublished":"2018-10-28T05:50:57.000Z","dateModified":"2018-10-28T05:50:57.000Z","author":{"@type":"Person","name":"Szymon Stepniak"},"description":"Yesterday I have found this interesting question on Stack Overflow asked by Opal. He faced some unexpected compilation errors when dealing with Java generics and Vavr library. It turned out the root cause of the issue there was not the library, but Java compiler itself. This was pretty interesting use case and it motivated me to investigate it even further. This blog post reveals untold truth about Java generics type inference. Are you ready? :)","keywords":"java,java-8,java-generics,type-inference,jsr335,jep101"}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand"><span>e.printStackTrace(); // Blog</span></a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/wololock/wololock.github.io">Github</a></li><li><a href="https://travis-ci.org/wololock/wololock.github.io"><img src="https://travis-ci.org/wololock/wololock.github.io.png?branch=develop"></a></li></ul></div></div></nav><header class="header-section"><div style="background-image:url(/images/java-type-inference-bg.jpg)" class="intro-header"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a href="/categories/Programming-tips/" class="category">Programming tips</a><h1>Java 8 type inference in generic methods chain call - what might go wrong?</h1><div class="post-meta"><ul><li><time datetime="2018-10-28T05:50:57.000Z" itemprop="datePublished">Oct 28, 2018</time></li><li>4 minutes read</li><li><a href="https://e.printstacktrace.blog/2018/10/java-type-inference-generic-methods-chain-call/#disqus_thread">0 Comments</a></li></ul></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><div class="paragraph"><p>Yesterday I have found this interesting question on Stack Overflow asked by <a href="https://twitter.com/czaszo" target="_blank" rel="noopener">Opal</a>. He faced some <a href="https://stackoverflow.com/q/53008601/2194470" target="_blank" rel="noopener">unexpected compilation errors</a> when dealing with Java generics and Vavr library. It turned out the root cause of the issue there was not the library, but Java compiler itself. This was pretty interesting use case and it motivated me to investigate it even further. This blog post reveals untold truth about Java generics type inference. Are you ready? :)</p></div><a id="more"></a><div class="sect1"><h2 id="an-example">An example</h2><div class="sectionbody"><div class="paragraph"><p>Let&#8217;s define a simple <code>Some&lt;T&gt;</code> generic class:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.util.function.Consumer;
import java.util.function.Supplier;

public final class Some&lt;T&gt; {

    private final T value;

    private Some(final T t) {
        this.value = t;
    }

    static &lt;T&gt; Some&lt;T&gt; of(final Supplier&lt;T&gt; supplier) {
        return new Some&lt;&gt;(supplier.get());
    }

    public Some&lt;T&gt; peek(final Consumer&lt;T&gt; consumer) {
        consumer.accept(value);
        return this;
    }

    public T get() {
        return value;
    }
}</code></pre></div></div><div class="paragraph"><p><code>Some&lt;T&gt;</code> represents some value provided by a supplier function. There is not much we can do we this object - its class provides only two additional methods, <code>peek(Consumer&lt;T&gt; consumer)</code> and <code>get()</code>. But that&#8217;s enough for this demo.</p></div><div class="paragraph"><p>There is one useful thing we would like to take advantage of - <code>peek()</code> method returns <code>Some&lt;T&gt;</code> which in this case is the reference to the caller object. This is very handy and it allows us to create a chain of methods. Let&#8217;s try it out and create <code>Some&lt;List&lt;? extends CharSequence&gt;&gt;</code> object:</p></div><div class="listingblock"><div class="title">Listing 1. Example 1</div><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final class SomeExample {

    public static void main(String[] args) {
        Some&lt;List&lt;? extends CharSequence&gt;&gt; some =
                Some.of(() -&gt; Arrays.asList("a", "b", "c"));

        System.out.println(some.get());
    }
}</code></pre></div></div><div class="paragraph"><p>So far so good - this simple example compiles and produces <code>[a, b, c]</code> in the console log when executed. Let&#8217;s modify the code a bit and use <code>peek()</code> method instead <code>System.out.println(some.get())</code>:</p></div><div class="listingblock"><div class="title">Listing 2. Example 2</div><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final class SomeExample {

    public static void main(String[] args) {
        Some&lt;List&lt;? extends CharSequence&gt;&gt; some =
                Some.of(() -&gt; Arrays.asList("a", "b", "c")).peek(System.out::println);
    }
}</code></pre></div></div><div class="paragraph"><p>And now something unexpected happens. Suddenly, compiler started complaining about incompatible types:</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/java-type-inference-error.png"><img src="/images/java-type-inference-error.png" alt="java type inference error"></a></div></div></div></div><div class="paragraph"><p>At some point it makes sense, because Java generics are invariant<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup> - Java Language Specification in chapter <strong>4.10. Subtyping</strong> says clearly:</p></div><div class="quoteblock"><blockquote><div class="paragraph"><p>Subtyping does not extend through parameterized types: <code>T</code> &lt;: <code>S</code> does not imply that <code>C&lt;T&gt;</code> &lt;: <code>C&lt;S&gt;</code>.</p></div></blockquote></div><div class="paragraph"><p>So why does the example without <code>peek()</code> method invocation worked?</p></div></div></div><div class="sect1"><h2 id="generalized-target-type-inference">Generalized Target-Type Inference</h2><div class="sectionbody"><div class="paragraph"><p>In the first example we have took an advantage of the feature introduced in Java 8 with JSR-335<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup> - Generalized Target-Type Inference, proposed as JEP-101<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup>. It added a whole new chapter to the language specification - <strong>Chapter 18. Type Inference</strong><sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</sup>. It made Java compiler context aware when it comes to type inference, so it can deduct the expected type from the left side of the expression and subtype<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnote_5" title="View footnote.">5</a>]</sup> if needed.</p></div><div class="paragraph"><p>It explains why Java compiler is satisfied by reducing expression on the right side to type <code>Some&lt;List&lt;? extends CharSequence&gt;&gt;</code> while assigning value to a <code>some</code> variable:</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/java-poly-expressions-in-action.png"><img src="/images/java-poly-expressions-in-action.png" alt="java poly expressions in action"></a></div></div></div></div><div class="paragraph"><p>It shows that even if:</p></div><div class="ulist"><ul><li><p><code>Arrays.asList("a", "b", "c")</code> returns <code>List&lt;String&gt;</code>,</p></li><li><p><code>Some.of(() &#8594; Arrays.asList("a", "b", "c"))</code> returns <code>Some&lt;List&lt;String&gt;&gt;</code>,</p></li></ul></div><div class="paragraph"><p>then assigning it to a type like <code>Some&lt;List&lt;? extends CharSequence&gt;&gt;</code> changes the invocation context and in this context <code>Some.of()</code> returns type defined on the left side of the assignment.</p></div></div></div><div class="sect1"><h2 id="limitations">Limitations</h2><div class="sectionbody"><div class="paragraph"><p>Java 8 type inference system has some limitations. One of them is type inference in chain methods call. JEP-101 mentions this problem, and our second example proves this limitation exists:</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/java-type-inference-chain-error.png"><img src="/images/java-type-inference-chain-error.png" alt="java type inference chain error"></a></div></div></div></div><div class="paragraph"><p>When we start chaining methods, compiler delays type inference until the expression on the right side gets evaluated. Last method in the chain receives <code>Some&lt;List&lt;String&gt;&gt;</code> from the first method and it passes it to variable assignment. This is why we see compiler error in this case.</p></div></div></div><div class="sect1"><h2 id="solutions">Solutions</h2><div class="sectionbody"><div class="paragraph"><p>There are two solutions (or workarounds) to this limitation.</p></div><div class="paragraph"><p>1) We can specify explicitly generic type:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final class SomeExample {

    public static void main(String[] args) {
        Some&lt;List&lt;? extends CharSequence&gt;&gt; some =
                Some.&lt;List&lt;? extends CharSequence&gt;&gt;of(() -&gt; Arrays.asList("a", "b", "c")).peek(System.out::println);
    }
}</code></pre></div></div><div class="paragraph"><p>In this case we instruct compiler that we expect <code>Some.of()</code> to return this specific type and it gets passed to <code>peek()</code> method which returns previously specified type back.</p></div><div class="paragraph"><p>2) We can break the chain and split assignment from the rest chain calls</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final class SomeExample {

    public static void main(String[] args) {
        Some&lt;List&lt;? extends CharSequence&gt;&gt; some = Some.of(() -&gt; Arrays.asList("a", "b", "c"));
        some.peek(System.out::println);
    }
}</code></pre></div></div></div></div><div class="sect1"><h2 id="conclusion">Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>And that&#8217;s it. I hope you have learned something useful from this blog post. Don&#8217;t hesitate to leave a comment in the comments section below - please let me know if you are looking for more articles like this one. See you next time!</p></div></div></div><div id="footnotes"><hr><div class="footnote" id="_footnote_1"><a href="#_footnoteref_1">1</a>. <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-4.html#jls-4.10" class="bare" target="_blank" rel="noopener">https://docs.oracle.com/javase/specs/jls/se8/html/jls-4.html#jls-4.10</a></div><div class="footnote" id="_footnote_2"><a href="#_footnoteref_2">2</a>. <a href="http://cr.openjdk.java.net/~dlsmith/jsr335-final/spec/G.html" class="bare" target="_blank" rel="noopener">http://cr.openjdk.java.net/~dlsmith/jsr335-final/spec/G.html</a></div><div class="footnote" id="_footnote_3"><a href="#_footnoteref_3">3</a>. <a href="https://openjdk.java.net/jeps/101" class="bare" target="_blank" rel="noopener">https://openjdk.java.net/jeps/101</a></div><div class="footnote" id="_footnote_4"><a href="#_footnoteref_4">4</a>. <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-18.html" class="bare" target="_blank" rel="noopener">https://docs.oracle.com/javase/specs/jls/se8/html/jls-18.html</a></div><div class="footnote" id="_footnote_5"><a href="#_footnoteref_5">5</a>. <a href="http://cr.openjdk.java.net/~dlsmith/jsr335-final/spec/G.html#18.2.3_Subtyping_Constraints_.5BNew.5D" class="bare" target="_blank" rel="noopener">http://cr.openjdk.java.net/~dlsmith/jsr335-final/spec/G.html#18.2.3_Subtyping_Constraints_.5BNew.5D</a></div></div><section class="post-tags"><a href="/tags/java/" class="tag post-meta">#java</a><a href="/tags/java-8/" class="tag post-meta">#java-8</a><a href="/tags/java-generics/" class="tag post-meta">#java-generics</a><a href="/tags/type-inference/" class="tag post-meta">#type-inference</a><a href="/tags/jsr335/" class="tag post-meta">#jsr335</a><a href="/tags/jep101/" class="tag post-meta">#jep101</a></section><footer class="post-footer"><img src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200" class="img-responsive img-circle"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Szymon Stepniak</h4><p>Groovista, Upwork's Top Rated freelancer, Toruń Java User Group founder, open&nbsp;source contributor, Stack Overflow addict, bedroom guitar player. I walk through e.printStackTrace() so you don't have to.</p><ul class="social-links"><li><a href="https://github.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://twitter.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/2017/09/divide-a-list-to-lists-of-n-size-in-Java-8/"><img src="/images/og/java-divide-list-to-lists.jpg" class="img-responsive"><h3>Divide a list to lists of n size in Java 8</h3></a><p>You have probably faced a few times a situation where you had to divide n-size list to lists of m-size. Something like:[1,2,3,4,5,6,7] -&gt; [[1,2], [3,4], [5,6], [7]]</p></div><div class="col-lg-4"><a href="/2018/10/what-is-the-most-efficient-way-to-iterate-collection-in-groovy-jmh/"><img src="/images/og/groovy-jmh-benchmark.jpg" class="img-responsive"><h3>What is the most efficient way to iterate collection in Groovy? Let's play with JMH!</h3></a><p>I guess you may heard about Groovy&#8217;s Collection.each(Closure cl) method - it was introduced 15 years ago [1] and it was a great alternative for a good old for-loop, for-each or even using an ...</p></div><div class="col-lg-4"><a href="/2018/09/how-groovy-equal-operator-is-different-from-java/"><img src="/images/og/groovy-equals-operator.jpg" class="img-responsive"><h3>How Groovy's equal operator differs from Java?</h3></a><p>One of the first mistakes people do when starting their journey with Java programming language is using == to compare objects instead calling a.equals(b). When you begin playing around with Groovy ...</p></div></div></section></article><nav role="pagination" class="pagination"><a href="/2018/10/micronaut-non-blocking-and-async-part-3/" class="pull-left btn">← Next post</a><a href="/2018/10/micronaut-non-blocking-and-async-part-2/" class="pull-right btn">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"></div></div></div><script>var url_parts=window.location.href.split("?"),disqus_url=url_parts[0];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//eprintstacktrace.disqus.com/embed.js",(document.head||d.body).appendChild(t)}()</script></div></div></div><script id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><footer class="site-footer"><div class="inner"><section class="copyright">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a></section><section class="poweredby"><ul><li><span>Published with </span><a href="https://hexo.io">Hexo</a></li><li><span>Hosted on </span><a href="https://github.com/wololock/wololock.github.io"><span class="fa fa-github"></span></a></li><li><span>Deployed with </span><a href="https://travis-ci.org/wololock/wololock.github.io">Travis CI</a></li><li><span>Subscribe </span><a href="http://feeds.feedburner.com/Eprintstacktracenet"><span class="fa fa-rss"></span></a></li></ul></section></div></footer><script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script><script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,n,o,t,c,g){a.GoogleAnalyticsObject=t,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(n),g=e.getElementsByTagName(n)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",g.parentNode.insertBefore(c,g)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"))</script></body></html>