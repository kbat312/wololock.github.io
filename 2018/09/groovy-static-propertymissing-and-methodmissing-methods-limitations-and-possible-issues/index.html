<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Szymon Stepniak"><title>Groovy: static propertyMissing and methodMissing methods - limitations and possible issues | e.printStackTrace(); // Blog</title><meta name="description" content="Some time ago I have found another interesting Groovy related question on Stack Overflow. This time someone was asking about static variants of popular propertyMissing and methodMissing methods. The official Groovy documentation does not explain how to..."><link rel="alternate" type="application/rss+xml" title="e.printStackTrace(); // Blog" href="/atom.xml"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.6.0/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=16"><link rel="stylesheet" href="/css/conum.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700"><meta name="description" content="Some time ago I have found another interesting Groovy related question on Stack Overflow. This time someone was asking about static variants of popular propertyMissing and methodMissing methods. The o"><meta name="keywords" content="groovy,metaprogramming"><meta property="og:type" content="article"><meta property="og:title" content="Groovy: static propertyMissing and methodMissing methods - limitations and possible issues"><meta property="og:url" content="https://e.printstacktrace.blog/2018/09/groovy-static-propertymissing-and-methodmissing-methods-limitations-and-possible-issues/index.html"><meta property="og:site_name" content="e.printStackTrace(); &#x2F;&#x2F; Blog"><meta property="og:description" content="Some time ago I have found another interesting Groovy related question on Stack Overflow. This time someone was asking about static variants of popular propertyMissing and methodMissing methods. The o"><meta property="og:locale" content="en"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/groovy-static-propertymissing.jpg"><meta property="og:updated_time" content="2018-09-08T21:22:19.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Groovy: static propertyMissing and methodMissing methods - limitations and possible issues"><meta name="twitter:description" content="Some time ago I have found another interesting Groovy related question on Stack Overflow. This time someone was asking about static variants of popular propertyMissing and methodMissing methods. The o"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/groovy-static-propertymissing.jpg"><meta name="twitter:creator" content="@wololock"></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand"><span>e.printStackTrace(); // Blog</span></a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/wololock/wololock.github.io">Github</a></li><li><a href="https://travis-ci.org/wololock/wololock.github.io"><img src="https://travis-ci.org/wololock/wololock.github.io.png?branch=develop"></a></li></ul></div></div></nav><header class="header-section"><div style="background-image:url(/img/index-header.jpg)" class="intro-header"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a href="/categories/Programming-tips/" class="category">Programming tips</a><h1>Groovy: static propertyMissing and methodMissing methods - limitations and possible issues</h1><div class="post-meta"><ul><li><time datetime="2018-09-08T21:22:19.000Z" itemprop="datePublished">Sep 8, 2018</time></li><li>7 minutes read</li><li><a href="https://e.printstacktrace.blog/2018/09/groovy-static-propertymissing-and-methodmissing-methods-limitations-and-possible-issues/#disqus_thread">0 Comments</a></li></ul></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><div class="paragraph"><p>Some time ago I have found another interesting <a href="https://stackoverflow.com/q/51921068/2194470" target="_blank" rel="noopener">Groovy related question on Stack Overflow</a>. This time someone was asking about static variants of popular <code>propertyMissing</code> and <code>methodMissing</code> methods. The official Groovy documentation does not explain how to do it - it only explains how to add any static method through <code>metaClass</code>. Today we are going to learn how to define these methods in two different ways.</p></div><a id="more"></a><div class="sect1"><h2 id="introduction">Introduction</h2><div class="sectionbody"><div class="paragraph"><p>Before we move on - I must admit that I never had to use static <code>methodMissing</code> and <code>propertyMissing</code> method variants in my daily Groovy practice. I use Groovy&#8217;s metaprogramming capability very, very rarely, yet I still prefer more compile-time metaprogramming features to make it as explicit as possible. However, there are some rare cases where doing runtime metaprogramming might make sense and it fits better to the problem we are trying to solve.</p></div><div class="paragraph"><p>Let&#8217;s say we have a very simple domain class <code>Person</code>.</p></div><div class="listingblock"><div class="title">Listing 1. Person domain class</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import groovy.transform.EqualsAndHashCode
import groovy.transform.ToString

@ToString
@EqualsAndHashCode
class Person {

    final String name

    Person(String name) {
        this.name = name
    }
}</code></pre></div></div><div class="paragraph"><p>Now, let&#8217;s say that for some reason we want to instantiate an object not by calling a constructor directly, but by accessing non-existing property which holds person&#8217;s name, for instance:</p></div><div class="listingblock"><div class="title">Listing 2. Creating <code>Person</code> instances through accessing non-existing class properties</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">assert Person.John == new Person('John')
assert Person.'Mary Jane' == new Person('Mary Jane')</code></pre></div></div></div></div><div class="sect1"><h2 id="adding-static-code-propertymissing-code-through-code-person-metaclass-code">Adding static <code>propertyMissing</code> through <code>Person.metaClass</code></h2><div class="sectionbody"><div class="paragraph"><p>As you can see we are going to use static variant of <code>propertyMissing</code> method. How to define it? The official <a href="http://groovy-lang.org/metaprogramming.html#_static_methods" target="_blank" rel="noopener">documentation says</a> we can do it similarly to adding an instance method, but with <code>static</code> qualifier added right before the method name. Something like this:</p></div><div class="listingblock"><div class="title">Listing 3. Defining static <code>propertyMissing</code> method for <code>Person</code> class</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import groovy.transform.EqualsAndHashCode
import groovy.transform.ToString

@ToString
@EqualsAndHashCode
class Person {

    final String name

    Person(String name) {
        this.name = name
    }
}

Person.metaClass.static.propertyMissing = { String name -&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    return new Person(name)
}

assert Person.John == new Person('John')
assert Person.'Mary Jane' == new Person('Mary Jane') <i class="conum" data-value="2"></i><b>(2)</b></code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>We define <code>propertyMissing</code> with <code>static</code> qualifier as a closure.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>We can put property name in quotes if it contains e.g. whitespace.</td></tr></table></div><div class="paragraph"><p>Looks like we are done and expression <code>Person.John</code> works as expected. The only thing we may don&#8217;t like is the fact we have to define this method outside the class definition. The first question that comes to mind is - where to put it? I have a single <code>Person</code> class file and I would like to use it whenever this class gets imported.</p></div></div></div><div class="sect1"><h2 id="adding-static-code-propertymissing-code-as-a-class-method">Adding static <code>propertyMissing</code> as a class method</h2><div class="sectionbody"><div class="paragraph"><p>Solution to this problem is very simple. The only problem is that you won&#8217;t find it in the official documentation. If we take a look at the source code of <code>groovy.lang.MetaClassImpl</code> class, <a href="https://github.com/apache/groovy/blob/GROOVY_2_5_X/src/main/groovy/groovy/lang/MetaClassImpl.java#L120-L124" target="_blank" rel="noopener">between lines 120 and 124</a> we can find something like this:</p></div><div class="listingblock"><div class="title">Listing 4. A part of <code>groovy.lang.MetaClassImpl</code> source code (lines 120-124)</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">    protected static final String STATIC_METHOD_MISSING = "$static_methodMissing";
    protected static final String STATIC_PROPERTY_MISSING = "$static_propertyMissing";
    protected static final String METHOD_MISSING = "methodMissing";
    protected static final String PROPERTY_MISSING = "propertyMissing";
    protected static final String INVOKE_METHOD_METHOD = "invokeMethod";</code></pre></div></div><div class="paragraph"><p>Method <code>$static_propertyMissing</code> sounds like something we are looking for. Let&#8217;s add this method to a <code>Person</code> class and see how it works:</p></div><div class="listingblock"><div class="title">Listing 5. <code>Person</code> class with implemented <code>$static_propertyMissing</code> method</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import groovy.transform.EqualsAndHashCode
import groovy.transform.ToString

@ToString
@EqualsAndHashCode
class Person {

    final String name

    Person(String name) {
        this.name = name
    }

    static def $static_propertyMissing(String name) {
        return new Person(name)
    }
}

assert Person.John == new Person('John')
assert Person.'Mary Jane' == new Person('Mary Jane')</code></pre></div></div><div class="paragraph"><p>Works like a charm. <code>$static_propertyMissing</code> is a member of <code>Person</code> class and this behavior gets imported with the class.</p></div></div></div><div class="sect1"><h2 id="adding-static-code-methodmissing-code-variant">Adding static <code>methodMissing</code> variant</h2><div class="sectionbody"><div class="paragraph"><p>I guess you have already figured out how to implement static variant of <code>methodMissing</code> method. The source code reveals that the name of this method is <code>$static_methodMissing</code>. Let&#8217;s see what we can do with it. If you know Grails Framework then you also know <a href="http://gorm.grails.org/" target="_blank" rel="noopener">GORM</a>. For those of you who are not familiar with it - in a simple words, GORM takes advantage of Groovy metaprogramming and it "translates" methods like <code>User.findByNameAndEmail(name, email)</code> to a Hibernate HQL queries. It&#8217;s a total simplification of what GORM is, but it doesn&#8217;t matter at this point. Let&#8217;s try to use <code>$static_methodMissing</code> implemented in <code>Person</code> class to support GORM-like methods:</p></div><div class="ulist"><ul><li><p><code>findByName(name)</code></p></li><li><p><code>findByNameAndAge(name, age)</code></p></li><li><p><code>findByNameOrAge(name, age)</code></p></li></ul></div><div class="paragraph"><p>Without any further ado let&#8217;s take a look at following example:</p></div><div class="listingblock"><div class="title">Listing 6. An example of GORM-like dynamic <code>findByXXX</code> method in <code>Person</code> class</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import groovy.transform.EqualsAndHashCode
import groovy.transform.ToString

import java.util.concurrent.CopyOnWriteArraySet

@ToString
@EqualsAndHashCode
class Person {

    private static Set&lt;Person&gt; people = [ <i class="conum" data-value="1"></i><b>(1)</b>
        new Person('John', 42)
    ] as CopyOnWriteArraySet


    final String name
    final int age

    Person(String name, int age) {
        this.name = name
        this.age = age
    }

    static def $static_methodMissing(String name, Object args) {
        if (name.startsWith('findBy')) { <i class="conum" data-value="2"></i><b>(2)</b>
            final String[] parts =  name.replace('findBy', '')
                    .split('(?=\\p{Upper})') <i class="conum" data-value="3"></i><b>(3)</b>
                    .collect { it.toLowerCase() } <i class="conum" data-value="4"></i><b>(4)</b>

            <i class="conum" data-value="5"></i><b>(5)</b>
            final Closure&lt;Boolean&gt; predicate = parts.size() == 1 ? { it.@(parts[0]) == args[0] } :
                    parts.size() == 3 ?
                            parts[1] == 'and' ?
                                    { it.@(parts[0]) == args[0] &amp;&amp; it.@(parts[2]) == args[1] } :
                                    parts[1] == 'or' ?
                                            { it.@(parts[0]) == args[0] || it.@(parts[2]) == args[1] } :
                                            {} : {}

            return people.find(predicate) <i class="conum" data-value="6"></i><b>(6)</b>

        }

        throw new MissingMethodException(name, Person, args)
    }
}

assert Person.findByNameAndAge('John', 21) == null
assert Person.findByNameAndAge('John', 42) == new Person('John', 42)
assert Person.findByNameOrAge('Denis', 42) == new Person('John', 42)
assert Person.findByName('John') == new Person('John', 42)
assert Person.findByName('Denis') == null</code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>We use internal <code>Set</code> to store some objects.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>We consider only missing methods that starts with <code>findBy</code> prefix.</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>We split remaining part by uppercase (e.g. <code>['Name', 'And', 'Age']</code>).</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>It&#8217;s time to lowercase <code>['name', 'and', 'age']</code>.</td></tr><tr><td><i class="conum" data-value="5"></i><b>5</b></td><td>Here we create a predicate expressed as a closure (very dirty and verbose way).</td></tr><tr><td><i class="conum" data-value="6"></i><b>6</b></td><td>And finally we call <code>find()</code> method to get the first element that matches predicate.</td></tr></table></div></div></div><div class="sect1"><h2 id="limitations">Limitations</h2><div class="sectionbody"><div class="paragraph"><p>There is one huge limitation if it comes to static variants of <code>propertyMissing</code> and <code>methodMissing</code> methods - you can&#8217;t define both of them in a single class. Not literally. You can still do it, but if you add <code>$static_propertyMissing</code> then your <code>$static_methodMissing</code> stops working and starts throwing exception like:</p></div><div class="listingblock"><div class="title">Listing 7. Exception thrown when both static variants are defined in the class</div><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Caught: groovy.lang.MissingMethodException: No signature of method: Person.call() is applicable for argument types: (String, Integer) values: [John, 21]
Possible solutions: wait(), any(), wait(long, int), collect(), dump(), find()
groovy.lang.MissingMethodException: No signature of method: Person.call() is applicable for argument types: (String, Integer) values: [John, 21]
Possible solutions: wait(), any(), wait(long, int), collect(), dump(), find()
	at test.run(test.groovy:70)</code></pre></div></div><div class="paragraph"><p>It happens because the method responsible for invoking static methods <a href="https://github.com/apache/groovy/blob/GROOVY_2_5_X/src/main/groovy/groovy/lang/MetaClassImpl.java#L1477" target="_blank" rel="noopener">calls <code>getProperty()</code></a> just in case caller might actually want to access property and not execute method. This sounds like a bug, because such behavior does not exist for non static variants of these two methods.</p></div><div class="listingblock"><div class="title">Listing 8. Combining <code>$static_propertyMissing</code> and <code>$static_methodMissing</code> causes excpetion</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import groovy.transform.EqualsAndHashCode
import groovy.transform.ToString

import java.util.concurrent.CopyOnWriteArraySet

@ToString
@EqualsAndHashCode
class Person {

    private static Set&lt;Person&gt; people = [
        new Person('John', 42)
    ] as CopyOnWriteArraySet


    final String name
    final int age

    Person(String name, int age) {
        this.name = name
        this.age = age
    }

    static def $static_propertyMissing(String name) {
        return new Person(name, 0)
    }

    static def $static_methodMissing(String name, Object args) {
        if (name.startsWith('findBy')) {
            final String[] parts =  name.replace('findBy', '')
                    .split('(?=\\p{Upper})')
                    .collect { it.toLowerCase() }

            final Closure&lt;Boolean&gt; predicate = parts.size() == 1 ? { it.@(parts[0]) == args[0] } :
                    parts.size() == 3 ?
                            parts[1] == 'and' ?
                                    { it.@(parts[0]) == args[0] &amp;&amp; it.@(parts[2]) == args[1] } :
                                    parts[1] == 'or' ?
                                            { it.@(parts[0]) == args[0] || it.@(parts[2]) == args[1] } :
                                            {} : {}

            return people.find(predicate)

        }

        throw new MissingMethodException(name, Person, args)
    }
}

assert Person.findByNameAndAge('John', 21) == null <i class="conum" data-value="1"></i><b>(1)</b></code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>This line throws <code>groovy.lang.MissingMethodException</code></td></tr></table></div></div></div><div class="sect1"><h2 id="conclusion">Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>Personally, I don&#8217;t use much runtime metaprogramming in my Groovy code. Mostly because it makes reasoning about the program at least a few times harder. But if you want to start playing around and write some DSL with Groovy then you might find runtime metaprogramming an interesting starting point. Happy hacking!</p></div></div></div><section class="post-tags"><a href="/tags/groovy/" class="tag post-meta">groovy</a><a href="/tags/metaprogramming/" class="tag post-meta">metaprogramming</a></section><footer class="post-footer"><div class="row"><div class="col-lg-2 col-md-2 col-sm-2 hidden-xs"><img src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200" class="img-responsive img-circle"></div><div class="col-lg-6 col-md-7 col-sm-6 col-xs-12 author"><h4>Szymon Stepniak</h4><p>Upwork's Top Rated freelancer, Toruń Java User Group founder, open source contributor, Stack Overflow active user, bedroom guitar player.</p><ul class="social-links"><li><a href="https://github.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://twitter.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li></ul></div><div class="col-lg-4 col-md-3 col-sm-4 col-xs-12 share"><h4>Share this post</h4><a href="https://twitter.com/share?url=https://e.printstacktrace.blog/2018/09/groovy-static-propertymissing-and-methodmissing-methods-limitations-and-possible-issues/&amp;via=wololock&amp;text=Groovy: static propertyMissing and methodMissing methods - limitations and possible issues" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1'><span class="fa fa-twitter"></span></a><a href="https://www.facebook.com/sharer/sharer.php?uhttps://e.printstacktrace.blog/2018/09/groovy-static-propertymissing-and-methodmissing-methods-limitations-and-possible-issues/" onclick='return window.open(this.href,"facebook-share","width=580,height=296"),!1'><span class="fa fa-facebook-square"></span></a><a href="https://plus.google.com/share?url=https://e.printstacktrace.blog/2018/09/groovy-static-propertymissing-and-methodmissing-methods-limitations-and-possible-issues/" onclick="window.open(this.href, &quot;google-plus-share&quot;, &quot;width=490,height=530&quot;);return false;"><span class="fa fa-google-plus-square"></span></a></div></div></footer></article><nav role="pagination" class="pagination"><a href="/2018/09/how-groovy-equal-operator-is-different-from-java/" class="pull-left btn">← Next post</a><a href="/2018/09/groovy-dynamic-types-coercion-and-promotion-you-have-been-warned/" class="pull-right btn">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"></div></div></div><script>var url_parts=window.location.href.split("?"),disqus_url=url_parts[0];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//eprintstacktrace.disqus.com/embed.js",(document.head||d.body).appendChild(t)}()</script></div></div></div><script id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><footer class="site-footer"><div class="inner"><section class="copyright">All content copyright &copy; 2017 &bull; All rights reserved.</section><section class="poweredby"><ul><li><span>Published with </span><a href="https://hexo.io">Hexo</a></li><li><span>Hosted on </span><a href="https://github.com/wololock/wololock.github.io"><span class="fa fa-github"></span></a></li><li><span>Deployed with </span><a href="https://travis-ci.org/wololock/wololock.github.io">Travis CI</a></li><li><span>Subscribe </span><a href="http://feeds.feedburner.com/Eprintstacktracenet"><span class="fa fa-rss"></span></a></li></ul></section></div></footer><script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script><script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,n,o,t,c,g){a.GoogleAnalyticsObject=t,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(n),g=e.getElementsByTagName(n)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",g.parentNode.insertBefore(c,g)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"))</script></body></html>