<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Szymon Stepniak"><meta name="robots" content="all"><title>GraalVM and Groovy - how to start?</title><meta name="description" content="GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller memory footprint. It sounds interesting enough to g..."><meta name="keywords" content="groovy,graalvm,native-image,openjdk"><link rel="shortcut icon" type="image/png" href="/favicon.png"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link rel="canonical" href="https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/"><link rel="alternate" type="application/rss+xml" title="e.printStackTrace(); // Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=28"><link rel="stylesheet" href="/css/conum.css?v=28"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700"><meta name="description" content="GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller"><meta name="keywords" content="groovy,graalvm,native-image,openjdk"><meta property="og:type" content="article"><meta property="og:title" content="GraalVM and Groovy - how to start?"><meta property="og:url" content="https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/index.html"><meta property="og:site_name" content="e.printStackTrace(); &#x2F;&#x2F; Blog"><meta property="og:description" content="GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller"><meta property="og:locale" content="en"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/graalvm-groovy-how-to-start.jpg"><meta property="og:updated_time" content="2018-10-03T21:28:49.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="GraalVM and Groovy - how to start?"><meta name="twitter:description" content="GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/graalvm-groovy-how-to-start.jpg"><meta name="twitter:creator" content="@wololock"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/"},"headline":"GraalVM and Groovy - how to start?","image":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/og/graalvm-groovy-how-to-start.jpg"},"datePublished":"2018-10-03T21:28:49.000Z","dateModified":"2018-10-03T21:28:49.000Z","author":{"@type":"Person","name":"Szymon Stepniak"},"publisher":{"@type":"Organization","name":"e.printStackTrace(); // Blog","logo":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/site-logo.jpg","height":60,"width":600}},"description":"GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller memory footprint. It sounds interesting enough to give it a try. And today we are going to play around a little bit with running simple Groovy program after compiling to a standalone native image.","keywords":"groovy,graalvm,native-image,openjdk"}</script></head><body class="layout-post"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand"><span>e.printStackTrace(); // Blog</span></a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/wololock/wololock.github.io">Github</a></li><li><a href="https://travis-ci.org/wololock/wololock.github.io"><img src="https://travis-ci.org/wololock/wololock.github.io.png?branch=develop"></a></li></ul></div></div></nav><header class="header-section"><div style="background-image:url(/img/graalvm-bg.jpg)" class="intro-header"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a href="/categories/how-to/" class="category">How to</a><h1>GraalVM and Groovy - how to start?</h1><div class="post-meta"><ul><li><time datetime="2018-10-03T21:28:49.000Z" itemprop="datePublished">Oct 3, 2018</time></li><li>12 minutes read</li><li><a href="https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/#disqus_thread">0 Comments</a></li></ul></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><div class="paragraph"><p><a href="https://www.graalvm.org/" target="_blank" rel="noopener">GraalVM</a> became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller memory footprint. It sounds interesting enough to give it a try. And today we are going to play around a little bit with running simple Groovy program after compiling to a standalone native image.</p></div><a id="more"></a><div class="sect1"><h2>Introduction</h2><div class="sectionbody"><div class="paragraph"><p>This blog post documents pretty simple use case of running Groovy code compiled to a GraalVM native image. It will give you a good understanding how to start and how to solve the problems you will most probably face when you start playing around with your own examples.</p></div></div></div><div class="sect1"><h2>Prerequisites</h2><div class="sectionbody"><div class="paragraph"><p>We will be using following tools:</p></div><div class="ulist"><ul><li><p><strong>GraalVM</strong> 1.0.0-RC7 <em>(the latest version while writing this blog post)</em></p></li><li><p><strong>Groovy</strong> 2.5.2</p></li></ul></div><div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content">The easiest way to install GraalVM and Groovy is to use <a href="https://sdkman.io/" target="_blank" rel="noopener">SDKMAN!</a> command line tool.</td></tr></table></div></div></div><div class="sect1"><h2>Let&#8217;s code</h2><div class="sectionbody"><div class="paragraph"><p>For the purpose of this experiment we are going to use a simple Groovy program that sums and multiplies numbers:</p></div><div class="listingblock"><div class="title">Listing 1. RandomNumber.groovy</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class RandomNumber {
    static void main(String[] args) {
        def random = new Random().nextInt(1000)

        println "The random number is: $random"

        def sum = (0..random).sum { int num -&gt; num * 2 }

        println "The doubled sum of numbers between 0 and $random is $sum"
    }
}</code></pre></div></div><div class="paragraph"><p>GraalVM prefers static compilation<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> and that is why we are going to create compiler configuration file like:</p></div><div class="listingblock"><div class="title">Listing 2. compiler.groovy</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">withConfig(configuration) {
    ast(groovy.transform.CompileStatic)
    ast(groovy.transform.TypeChecked)
}</code></pre></div></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">Alternatively you could annotate the class with <code>@groovy.transform.CompileStatic</code> and <code>@groovy.transform.TypeChecked</code>.</td></tr></table></div><div class="paragraph"><p>We are ready to compile our code with <code>groovyc</code> compiler:</p></div><div class="listingblock"><div class="title">Listing 3. Compiling Groovy code</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">groovyc --configscript compiler.groovy RandomNumber.groovy</code></pre></div></div><div class="paragraph"><p>Code compiled. Let&#8217;s make sure we are using a correct GraalVM JDK:</p></div><div class="listingblock"><div class="title">Listing 4. Checking Java version</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -version

openjdk version "1.8.0_172"
OpenJDK Runtime Environment (build 1.8.0_172-20180625212755.graaluser.jdk8u-src-tar-g-b11)
GraalVM 1.0.0-rc7 (build 25.71-b01-internal-jvmci-0.48, mixed mode)</code></pre></div></div><div class="paragraph"><p>Everything is ready. Let&#8217;s run the code using GraalVM JDK:</p></div><div class="listingblock"><div class="title">Listing 5. Running Java program with GraalVM</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar" RandomNumber
The random number is: 876
The doubled sum of numbers between 0 and 876 is 768252</code></pre></div></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">Running Groovy compiled code as a Java program requires adding <code>org.codehaus.groovy:groovy:2.5.2:jar</code> to the classpath. In this example I am using JAR file from my local Maven repository.</td></tr></table></div></div></div><div class="sect1"><h2>Creating native image</h2><div class="sectionbody"><div class="paragraph"><p>Running our example inside the JVM was nice, but GraalVM offers much more. We can create standalone native image that will consume much less memory and will execute in a blink of an eye. Let&#8217;s give it a try:</p></div><div class="listingblock"><div class="title">Listing 6. Building native image with GraalVM</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">native-image -H:+ReportUnsupportedElementsAtRuntime \
        -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar" \
        --no-server \
        RandomNumber</code></pre></div></div><div class="paragraph"><p>Running the command will produce a following output:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[randomnumber:13187]    classlist:   2,144.27 ms
[randomnumber:13187]        (cap):     662.01 ms
[randomnumber:13187]        setup:   1,245.07 ms
[randomnumber:13187]   (typeflow):   7,048.82 ms
[randomnumber:13187]    (objects):   6,547.35 ms
[randomnumber:13187]   (features):     119.57 ms
[randomnumber:13187]     analysis:  15,433.33 ms
[randomnumber:13187]     universe:     564.07 ms
[randomnumber:13187]      (parse):   1,903.46 ms
[randomnumber:13187]     (inline):   2,529.37 ms
[randomnumber:13187]    (compile):  11,180.52 ms
[randomnumber:13187]      compile:  19,392.95 ms
[randomnumber:13187]        image:   1,872.31 ms
[randomnumber:13187]        write:     373.53 ms
[randomnumber:13187]      [total]:  42,717.44 ms</code></pre></div></div><div class="paragraph"><p>Let&#8217;s run the program then:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./randomnumber</code></pre></div></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">The random number is: 139
Exception in thread "main" groovy.lang.MissingMethodException: No signature of method: RandomNumber$_main_closure1.doCall() is applicable for argument types: (Integer) values: [0]
Possible solutions: findAll(), findAll(), isCase(java.lang.Object), isCase(java.lang.Object)
	at java.lang.Throwable.&lt;init&gt;(Throwable.java:250)
	at java.lang.Exception.&lt;init&gt;(Exception.java:54)
	at java.lang.RuntimeException.&lt;init&gt;(RuntimeException.java:51)
	at groovy.lang.GroovyRuntimeException.&lt;init&gt;(GroovyRuntimeException.java:33)
	at groovy.lang.MissingMethodException.&lt;init&gt;(MissingMethodException.java:49)
	at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:256)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at groovy.lang.Closure.call(Closure.java:421)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6613)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6513)
	at RandomNumber.main(RandomNumber.groovy:8)
	at com.oracle.svm.core.JavaMainWrapper.run(JavaMainWrapper.java:163)</code></pre></div></div><div class="paragraph"><p>Something went wrong. The first print <code>The random number is: 139</code> was shown in the console, but executing sum operation with a closure failed with the exception. The reason of this is because GraalVM uses <a href="https://www.graalvm.org/docs/reference-manual/aot-compilation/" target="_blank" rel="noopener">AOT (ahead of time) compilation</a>, which comes with some limitations (e.g. when it comes to Java reflection). The good news is that GraalVM allows us to configure manually which classes are loaded via reflection, so GraalVM will be ready to do so. Let&#8217;s create a file called <code>reflection.json</code> with the following content:</p></div><div class="listingblock"><div class="title">Listing 7. reflection.json</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name": "RandomNumber$_main_closure1",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  }
]</code></pre></div></div><div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content">More about manual reflection configuration can be found <a href="https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md#manual-configuration" target="_blank" rel="noopener">here</a>.</td></tr></table></div><div class="paragraph"><p>Let&#8217;s run <code>native-image</code> again, but this time with <code>-H:ReflectionConfigurationFiles=reflection.json</code> parameter added:</p></div><div class="listingblock"><div class="title">Listing 8. Building native image with GraalVM</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">native-image -H:+ReportUnsupportedElementsAtRuntime \
        -H:ReflectionConfigurationFiles=reflection.json \
        -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar" \
        --no-server \
        RandomNumber</code></pre></div></div><div class="paragraph"><p>When we run <code>./randomnumber</code> now, we will something like this in the console:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">The random number is: 673
java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$519
	at java.lang.Throwable.&lt;init&gt;(Throwable.java:287)
	at java.lang.Exception.&lt;init&gt;(Exception.java:84)
	at java.lang.ReflectiveOperationException.&lt;init&gt;(ReflectiveOperationException.java:75)
	at java.lang.ClassNotFoundException.&lt;init&gt;(ClassNotFoundException.java:82)
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:51)
	at com.oracle.svm.core.jdk.Target_java_lang_ClassLoader.loadClass(Target_java_lang_ClassLoader.java:126)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:101)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.proxy(GeneratedMetaMethod.java:93)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.isValidMethod(GeneratedMetaMethod.java:78)
	at groovy.lang.MetaClassImpl.chooseMethodInternal(MetaClassImpl.java:3232)
	at groovy.lang.MetaClassImpl.chooseMethod(MetaClassImpl.java:3194)
	at groovy.lang.MetaClassImpl.getNormalMethodWithCaching(MetaClassImpl.java:1402)
	at groovy.lang.MetaClassImpl.getMethodWithCaching(MetaClassImpl.java:1317)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1087)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6620)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6513)
	at RandomNumber.main(RandomNumber.groovy:8)
	at com.oracle.svm.core.JavaMainWrapper.run(JavaMainWrapper.java:163)
Exception in thread "main" groovy.lang.GroovyRuntimeException: Failed to create DGM method proxy : java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$519
	at java.lang.Throwable.&lt;init&gt;(Throwable.java:287)
	at java.lang.Exception.&lt;init&gt;(Exception.java:84)
	at java.lang.RuntimeException.&lt;init&gt;(RuntimeException.java:80)
	at groovy.lang.GroovyRuntimeException.&lt;init&gt;(GroovyRuntimeException.java:46)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:106)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.proxy(GeneratedMetaMethod.java:93)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.isValidMethod(GeneratedMetaMethod.java:78)
	at groovy.lang.MetaClassImpl.chooseMethodInternal(MetaClassImpl.java:3232)
	at groovy.lang.MetaClassImpl.chooseMethod(MetaClassImpl.java:3194)
	at groovy.lang.MetaClassImpl.getNormalMethodWithCaching(MetaClassImpl.java:1402)
	at groovy.lang.MetaClassImpl.getMethodWithCaching(MetaClassImpl.java:1317)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1087)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6620)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6513)
	at RandomNumber.main(RandomNumber.groovy:8)
	at com.oracle.svm.core.JavaMainWrapper.run(JavaMainWrapper.java:163)
Caused by: java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$519
	at java.lang.Throwable.&lt;init&gt;(Throwable.java:287)
	at java.lang.Exception.&lt;init&gt;(Exception.java:84)
	at java.lang.ReflectiveOperationException.&lt;init&gt;(ReflectiveOperationException.java:75)
	at java.lang.ClassNotFoundException.&lt;init&gt;(ClassNotFoundException.java:82)
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:51)
	at com.oracle.svm.core.jdk.Target_java_lang_ClassLoader.loadClass(Target_java_lang_ClassLoader.java:126)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:101)
	... 12 more</code></pre></div></div><div class="paragraph"><p>This time class <code>org.codehaus.groovy.runtime.dgm$519</code> cannot be found. These <code>dgm$&#8230;&#8203;</code> classes are Groovy classes representing generate meta methods. Let&#8217;s add it to the <code>reflection.json</code> and repeat the last two steps. It will fail one more time - this time class <code>org.codehaus.groovy.runtime.dgm$1172</code> cannot be found. Let&#8217;s add it and repeat. Final <code>reflection.json</code> file should look like this:</p></div><div class="listingblock"><div class="title">Listing 9. reflection.json</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name": "RandomNumber$_main_closure1",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  },
  {
    "name": "org.codehaus.groovy.runtime.dgm$519",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  },
  {
    "name": "org.codehaus.groovy.runtime.dgm$1172",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  }
]</code></pre></div></div><div class="paragraph"><p>And now when we try to run <code>./randomnumber</code> we will see the following output:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">The random number is: 161
The doubled sum of numbers between 0 and 161 is 26082</code></pre></div></div><div class="paragraph"><p>It worked, finally! In this case we only had to add these 3 classes to reflection configuration. When you run your own example you may have to add even more before your program executes as expected.</p></div></div></div><div class="sect1"><h2>Let&#8217;s compare execution times</h2><div class="sectionbody"><div class="paragraph"><p>After building and running standalone executable it is a good time to make a short comparison. We are not going to do a detailed benchmark - we just want to test the cold start of the program in 3 different variants.</p></div><div class="paragraph"><p><strong>1:</strong> Running <code>RandomNumber.groovy</code> with a <code>groovy</code> command line (<strong>1,03s</strong>):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">time groovy RandomNumber

The random number is: 546
The doubled sum of numbers between 0 and 546 is 298662

groovy RandomNumber  1,03s user 0,06s system 192% cpu 0,567 total</code></pre></div></div><div class="paragraph"><p><strong>2:</strong> Running compiled Groovy code with GraalVM JVM (<strong>0,50s</strong>):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">time java -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar" RandomNumber

The random number is: 437
The doubled sum of numbers between 0 and 437 is 191406

java -cp  RandomNumber  0,50s user 0,04s system 194% cpu 0,274 total</code></pre></div></div><div class="paragraph"><p><strong>3:</strong> Running standalone native image (<strong>0,00s</strong>):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">time ./randomnumber

The random number is: 675
The doubled sum of numbers between 0 and 675 is 456300

./randomnumber  0,00s user 0,00s system 92% cpu 0,007 total</code></pre></div></div><div class="paragraph"><p>That&#8217;s amazing! I wouldn&#8217;t thought that Java program can execute in a blink of an eye. And here you can see what does it look like in action:</p></div><script src="https://asciinema.org/a/uSh0zfA1JJede8J4R4lQy4FdK.js" id="asciicast-uSh0zfA1JJede8J4R4lQy4FdK" async></script></div></div><div class="sect1"><h2>Limitations</h2><div class="sectionbody"><div class="paragraph"><p>I must say that not everything look so bright. You have to be aware of many limitations you will face when you start building Groovy native images with GraalVM:</p></div><div class="olist arabic"><ol class="arabic"><li><p>Building native images from dynamic Groovy scripts does not work at the moment<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.</p></li><li><p>Dynamic runtime metaprogramming may not work at all in GraalVM (some parts may be fixed by configuring classes for AOT reflection).</p></li><li><p>Closures require manual configuration for reflection and you will face some issues when trying to cast a closure to some other type (e.g. when you use a closure in place of a functional interface).</p></li><li><p><a href="http://docs.groovy-lang.org/latest/html/documentation/grape.html" target="_blank" rel="noopener">Grape</a>, one of the most valuable Groovy scripts feature won&#8217;t work as standalone native image, because it requires Groovy command line tool and its class loader that understand what does <code>@Grab</code> annotation mean.</p></li><li><p>And last but not least - Groovy native image for this example weight 24 MB, which is quite a lot comparing to what this application does.</p></li></ol></div><div class="sect2"><h3>An example</h3><div class="paragraph"><p>Before we close this article, let&#8217;s take a look at example that does not work with GraalVM. Let&#8217;s refactor above example to use Java 8 Stream API and closures in place of lambda expressions:</p></div><div class="listingblock"><div class="title">Listing 10. RandomNumber.groovy</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import groovy.transform.CompileStatic
import groovy.transform.TypeChecked

import java.util.stream.IntStream

@CompileStatic
@TypeChecked
class RandomNumber {
    static void main(String[] args) {
        def random = new Random().nextInt(1000)

        println "The random number is: $random"

        Long sum = IntStream.rangeClosed(0, random)
                    .boxed()
                    .map { it * 2 }
                    .mapToLong { it -&gt; (long) it }
                    .sum()

        println "The doubled sum of numbers between 0 and $random is $sum"
    }
}</code></pre></div></div><div class="paragraph"><p>It compiles, GraalVM JDK runs it on JVM, native image builds. But when we try to run it we will see following output:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">The random number is: 226
Exception in thread "main" org.codehaus.groovy.runtime.typehandling.GroovyCastException: Cannot cast object 'RandomNumber$_main_closure1@7fcfe0745d78' with class 'RandomNumber$_main_closure1' to class 'java.util.function.Function'
	at java.lang.Throwable.&lt;init&gt;(Throwable.java:265)
	at java.lang.Exception.&lt;init&gt;(Exception.java:66)
	at java.lang.RuntimeException.&lt;init&gt;(RuntimeException.java:62)
	at java.lang.ClassCastException.&lt;init&gt;(ClassCastException.java:58)
	at org.codehaus.groovy.runtime.typehandling.GroovyCastException.&lt;init&gt;(GroovyCastException.java:40)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.continueCastOnSAM(DefaultTypeTransformation.java:414)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.continueCastOnNumber(DefaultTypeTransformation.java:328)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.castToType(DefaultTypeTransformation.java:242)
	at org.codehaus.groovy.runtime.ScriptBytecodeAdapter.castToType(ScriptBytecodeAdapter.java:617)
	at RandomNumber.main(RandomNumber.groovy:15)
	at com.oracle.svm.core.JavaMainWrapper.run(JavaMainWrapper.java:163)</code></pre></div></div><div class="paragraph"><p>As you can see closure we used for <code>map</code> operation cannot be cast to <code>java.util.function.Function</code> and program terminates. This is a huge problem for many Groovy programs - we tend to use closure in place of other types and we expect correct coercion to happen. I&#8217;m guessing this example requires some effort and finding which classes should be configured manually for reflection. I will share an update when I find solution to that problem.</p></div></div></div></div><div class="sect1"><h2>Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>I hope you have learned something useful from this blog post. I will continue exploring the world of GraalVM in cooperation with different technologies. I&#8217;m looking forward for learning and experimenting with more real-life and useful examples. I strongly encourage you to keep an eye on GraalVM - it is one of the hottest JVM topics these days for a good reason. And if you are looking for a project that is experimenting actively with GraalVM, take a look at <a href="http://micronaut.io/" target="_blank" rel="noopener">Micronaut</a> framework - people from <a href="https://objectcomputing.com/" target="_blank" rel="noopener">OCI</a> did a great job in this area and they documented their efforts in an official Micronaut user guide.</p></div></div></div><div class="sect1"><h2>Useful resources</h2><div class="sectionbody"><div class="ulist"><ul><li><p><a href="https://github.com/graemerocher/micronaut-graal-experiments" class="bare" target="_blank" rel="noopener">https://github.com/graemerocher/micronaut-graal-experiments</a></p></li><li><p><a href="https://medium.com/graalvm/instant-netty-startup-using-graalvm-native-image-generation-ed6f14ff7692" class="bare" target="_blank" rel="noopener">https://medium.com/graalvm/instant-netty-startup-using-graalvm-native-image-generation-ed6f14ff7692</a></p></li><li><p><a href="http://guides.micronaut.io/micronaut-creating-first-graal-app/guide/index.html" class="bare" target="_blank" rel="noopener">http://guides.micronaut.io/micronaut-creating-first-graal-app/guide/index.html</a></p></li><li><p><a href="https://blog.frankel.ch/first-impressions-graalvm/" class="bare" target="_blank" rel="noopener">https://blog.frankel.ch/first-impressions-graalvm/</a></p></li></ul></div></div></div><div id="footnotes"><hr><div class="footnote" id="_footnotedef_1"><a href="#_footnoteref_1">1</a>. <a href="https://github.com/oracle/graal/issues/346#issuecomment-383015796" class="bare" target="_blank" rel="noopener">https://github.com/oracle/graal/issues/346#issuecomment-383015796</a></div><div class="footnote" id="_footnotedef_2"><a href="#_footnoteref_2">2</a>. <a href="https://github.com/oracle/graal/issues/708" class="bare" target="_blank" rel="noopener">https://github.com/oracle/graal/issues/708</a></div></div><section class="post-tags"><a href="/tags/groovy/" class="tag post-meta">#groovy</a><a href="/tags/graalvm/" class="tag post-meta">#graalvm</a><a href="/tags/native-image/" class="tag post-meta">#native-image</a><a href="/tags/openjdk/" class="tag post-meta">#openjdk</a></section><footer class="post-footer"><img src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200" class="img-responsive img-circle"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Szymon Stepniak</h4><p>Groovista, Upwork's Top Rated freelancer, Toruń Java User Group founder, open&nbsp;source contributor, Stack Overflow addict, bedroom guitar player. I walk through e.printStackTrace() so you don't have to.</p><ul class="social-links"><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/channel/UCEf8e5YAYnowq-2deW4tpsw/featured" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/graalvm-groovy-grape-creating-native-image-of-standalone-script/"><img src="/images/og/graalvm-groovy-grape.jpg" class="img-responsive"><h3>GraalVM with Groovy and Grape - creating native image of a standalone script</h3></a><p>GraalVM 1.0.0-RC11 was released yesterday, and I thought it would be an excellent excuse to play around with it a while. I decided to create a simple Groovy script that uses Grape dependency manage...</p></div><div class="col-lg-4"><a href="/graalvm-native-image-inside-docker-container-does-it-make-sense/"><img src="/images/og/graalvm-docker-groovy.jpg" class="img-responsive"><h3>GraalVM native image inside docker container - does it make sense?</h3></a><p>We have learned how to create GraalVM native image from standalone Groovy script in the previous blog post. Today we continue the experiments, and this time we are going to create a Docker image to...</p></div><div class="col-lg-4"><a href="/ratpack-graalvm-how-to-start/"><img src="/images/og/ratpack-graalvm-how-to-start.jpg" class="img-responsive"><h3>Ratpack on GraalVM - how to start?</h3></a><p>The journey inside the exciting world of GraalVM continues. Today I would like to share with you results of running Ratpack on GraalVM experiment. You are going to learn how to build a native binar...</p></div></div></section></article><nav role="pagination" class="pagination"><a href="/how-to-avoid-no-tests-were-found-when-using-junit5-with-groovy/" class="pull-left btn">← Next post</a><a href="/what-is-the-most-efficient-way-to-iterate-collection-in-groovy-jmh/" class="pull-right btn">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"></div></div></div><script>var url_parts=window.location.href.split("?"),disqus_url=url_parts[0];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//eprintstacktrace.disqus.com/embed.js",(document.head||d.body).appendChild(t)}()</script></div></div></div><script id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><footer class="site-footer"><div class="container-fluid"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1"><div class="row"><div class="col-lg-4"><h4>e.printstacktrace.blog © 2019</h4><p><em>"I walk through e.printStackTrace() so you don't have to"</em></p><p><a href="/privacy-policy/">Privacy policy</a></p><p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a></p></div><div class="col-lg-4"><h4 class="marked">Recent articles</h4><section class="recent-posts"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/graalvm-heap-size-of-native-image-how-to-set-it/">GraalVM and heap size of the native image - how to set it?</a></li><li class="post-list-item"><a class="post-list-link" href="/using-the-same-prefix-with-different-http-methods-in-ratpack/">Using the same prefix with different HTTP methods in Ratpack</a></li><li class="post-list-item"><a class="post-list-link" href="/pragmatic-thinking-and-learning-book-review/">Pragmatic Thinking and Learning - book review</a></li><li class="post-list-item"><a class="post-list-link" href="/installing-graalvm-ee-1-0-0-rc14-with-sdkman/">Installing GraalVM EE 1.0.0-RC14 with SDKMAN!</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-regular-expressions-the-definitive-guide/">Groovy regular expressions - the definitive guide</a></li><li class="post-list-item"><a class="post-list-link" href="/intellij-idea-git-gpg-failed-to-sign-the-data/">IntelliJ IDEA and Git's "gpg failed to sign the data"</a></li></ul></section></div><div class="col-lg-4"><h4 class="marked">Stay connected</h4><div class="social-links"><ul><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/channel/UCEf8e5YAYnowq-2deW4tpsw/featured" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div><h4 class="marked">Most popular tags</h4><section class="tagcloud"><a href="/tags/async/" style="font-size:12pt;color:#777">async</a> <a href="/tags/book/" style="font-size:16pt;color:#858585">book</a> <a href="/tags/git/" style="font-size:8pt;color:#6a6a6a">git</a> <a href="/tags/github/" style="font-size:8pt;color:#6a6a6a">github</a> <a href="/tags/graalvm/" style="font-size:24pt;color:#9f9f9f">graalvm</a> <a href="/tags/groovy/" style="font-size:32pt;color:#bababa">groovy</a> <a href="/tags/haskell/" style="font-size:12pt;color:#777">haskell</a> <a href="/tags/java/" style="font-size:28pt;color:#adadad">java</a> <a href="/tags/java-8/" style="font-size:12pt;color:#777">java-8</a> <a href="/tags/jmh/" style="font-size:16pt;color:#858585">jmh</a> <a href="/tags/learning/" style="font-size:12pt;color:#777">learning</a> <a href="/tags/micronaut/" style="font-size:12pt;color:#777">micronaut</a> <a href="/tags/native-image/" style="font-size:16pt;color:#858585">native-image</a> <a href="/tags/non-blocking/" style="font-size:16pt;color:#858585">non-blocking</a> <a href="/tags/progress/" style="font-size:8pt;color:#6a6a6a">progress</a> <a href="/tags/ratpack/" style="font-size:20pt;color:#929292">ratpack</a> <a href="/tags/reactive-programming/" style="font-size:12pt;color:#777">reactive-programming</a> <a href="/tags/review/" style="font-size:16pt;color:#858585">review</a> <a href="/tags/rxjava/" style="font-size:12pt;color:#777">rxjava</a> <a href="/tags/session/" style="font-size:8pt;color:#6a6a6a">session</a> <a href="/tags/split/" style="font-size:8pt;color:#6a6a6a">split</a> <a href="/tags/spock/" style="font-size:12pt;color:#777">spock</a> <a href="/tags/stackoverflow/" style="font-size:12pt;color:#777">stackoverflow</a> <a href="/tags/tail-recursion/" style="font-size:8pt;color:#6a6a6a">tail-recursion</a> <a href="/tags/unit-test/" style="font-size:12pt;color:#777">unit-test</a></section></div></div></div></div></div><section class="poweredby"><ul class="text-center"><li><span>Published with </span><a href="https://hexo.io" onclick="return window.open(this.href),!1"><img src="/img/logo-hexo.png"></a></li><li><span>Hosted on </span><a href="https://github.com/wololock/wololock.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-github.png"></a></li><li><span>Deployed with </span><a href="https://travis-ci.org/wololock/wololock.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-travis.png"></a></li></ul></section></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="1.6rem" data-bg="#444"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,n,o,t,c,g){a.GoogleAnalyticsObject=t,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(n),g=e.getElementsByTagName(n)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",g.parentNode.insertBefore(c,g)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"))</script></body></html>