<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Szymon Stepniak"><meta name="robots" content="all"><title>GraalVM with Groovy and Grape - creating native image of a standalone script</title><meta name="description" content="GraalVM 1.0.0-RC11 was released yesterday, and I thought it would be an excellent excuse to play around with it a while. I decided to create a simple Groovy script that uses Grape dependency management system to load an external library and create a st..."><meta name="keywords" content="groovy,graalvm,grape,native-image"><link rel="shortcut icon" type="image/png" href="/favicon.png"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link rel="canonical" href="https://e.printstacktrace.blog/graalvm-groovy-grape-creating-native-image-of-standalone-script/"><link rel="alternate" type="application/rss+xml" title="e.printStackTrace(); // Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=32"><link rel="stylesheet" href="/css/conum.css?v=32"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700"><meta name="description" content="GraalVM 1.0.0-RC11 was released yesterday, and I thought it would be an excellent excuse to play around with it a while. I decided to create a simple Groovy script that uses Grape dependency managemen"><meta name="keywords" content="groovy,graalvm,grape,native-image"><meta property="og:type" content="article"><meta property="og:title" content="GraalVM with Groovy and Grape - creating native image of a standalone script"><meta property="og:url" content="https://e.printstacktrace.blog/graalvm-groovy-grape-creating-native-image-of-standalone-script/index.html"><meta property="og:site_name" content="e.printStackTrace(); &#x2F;&#x2F; Blog"><meta property="og:description" content="GraalVM 1.0.0-RC11 was released yesterday, and I thought it would be an excellent excuse to play around with it a while. I decided to create a simple Groovy script that uses Grape dependency managemen"><meta property="og:locale" content="en"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/graalvm-groovy-grape.jpg"><meta property="og:updated_time" content="2019-01-19T09:34:02.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="GraalVM with Groovy and Grape - creating native image of a standalone script"><meta name="twitter:description" content="GraalVM 1.0.0-RC11 was released yesterday, and I thought it would be an excellent excuse to play around with it a while. I decided to create a simple Groovy script that uses Grape dependency managemen"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/graalvm-groovy-grape.jpg"><meta name="twitter:creator" content="@wololock"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://e.printstacktrace.blog/graalvm-groovy-grape-creating-native-image-of-standalone-script/"},"headline":"GraalVM with Groovy and Grape - creating native image of a standalone script","image":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/og/graalvm-groovy-grape.jpg"},"datePublished":"2019-01-16T14:14:42.000Z","dateModified":"2019-01-19T09:34:02.000Z","author":{"@type":"Person","name":"Szymon Stepniak"},"publisher":{"@type":"Organization","name":"e.printStackTrace(); // Blog","logo":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/site-logo.jpg","height":60,"width":600}},"description":"GraalVM 1.0.0-RC11 was released yesterday, and I thought it would be an excellent excuse to play around with it a while. I decided to create a simple Groovy script that uses Grape dependency management system to load an external library and create a standalone native image from it. I thought it wouldn&#8217;t be possible, but luckily - I was wrong.","keywords":"groovy,graalvm,grape,native-image"}</script></head><body class="layout-post"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand"><span>e.printStackTrace(); // Blog</span></a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/wololock/wololock.github.io">Github</a></li><li><a href="https://travis-ci.org/wololock/wololock.github.io"><img src="https://travis-ci.org/wololock/wololock.github.io.png?branch=develop"></a></li></ul></div></div></nav><header class="header-section"><div style="background-image:url(/images/graalvm-groovy-bg.jpg)" class="intro-header"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a href="/categories/groovy-cookbook/" class="category">Groovy Cookbook</a><h1>GraalVM with Groovy and Grape - creating native image of a standalone script</h1><div class="post-meta"><ul><li><time datetime="2019-01-16T14:14:42.000Z" itemprop="datePublished">Jan 16, 2019</time></li><li>12 minutes read</li><li><a href="https://e.printstacktrace.blog/graalvm-groovy-grape-creating-native-image-of-standalone-script/#disqus_thread">0 Comments</a></li></ul></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><div class="paragraph"><p><a href="https://www.graalvm.org/" target="_blank" rel="noopener">GraalVM</a> 1.0.0-RC11 was released yesterday, and I thought it would be an excellent excuse to play around with it a while. I decided to create a simple Groovy script that uses <a href="http://docs.groovy-lang.org/latest/html/documentation/grape.html" target="_blank" rel="noopener">Grape dependency management</a> system to load an external library and create a standalone native image from it. I thought it wouldn&#8217;t be possible, but luckily - I was wrong.</p></div><a id="more"></a><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">The source code of the examples explained below can be found here <a href="https://github.com/wololock/graalvm-groovy-examples/tree/master/grape-script-example" target="_blank" rel="noopener">wololock/graalvm-groovy-examples</a></td></tr></table></div><div class="sect1"><h2>Prerequisites</h2><div class="sectionbody"><div class="paragraph"><p>Let&#8217;s start with defining runtime environment.</p></div><div class="ulist"><ul><li><p><strong>GraalVM</strong> 1.0.0-RC11 (the most recent version available while writing this blog post)</p></li><li><p><strong>Groovy</strong> 2.5.2</p></li></ul></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">I use a great command line tool called <a href="https://sdkman.io/" target="_blank" rel="noopener">SDKMAN!</a> to install both, GraalVM JDK and Groovy library. It allows me to install GraalVM with the following command: <code>sdk install java 1.0.0-rc-11-grl</code> and then I can switch to this Java version for current shell session with <code>sdk use java 1.0.0-rc-11-grl</code>.</td></tr></table></div></div></div><div class="sect1"><h2>The code</h2><div class="sectionbody"><div class="paragraph"><p>In this article, I will use a reasonably simple Groovy script. This script expects a single command line argument - a website URL, and it displays to the console the information about how many links given website contains. Nothing fancy, but you probably see how we could extend this example to do something more useful.</p></div><div class="listingblock"><div class="title">Listing 1. src/CountLinks.groovy</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">#!groovy
import org.jsoup.Jsoup
import org.jsoup.nodes.Document

@Grab(group='org.jsoup', module='jsoup', version='1.11.3')

final String url = args[0]

final Document doc = Jsoup.connect(url).get()
final int links = doc.select("a").size()
println "Website ${url} contains ${links} links."</code></pre></div></div><div class="paragraph"><p>We can run it and see how much time it took to produce the output.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; time groovy CountLinks.groovy https://e.printstacktrace.blog
Website https://e.printstacktrace.blog contains 95 links.
groovy CountLinks.groovy https://e.printstacktrace.blog  6,29s user 0,26s system 390% cpu 1,677 total</code></pre></div></div><div class="paragraph"><p>It took around <strong>1.7 seconds</strong> to produce the result. Quite long, especially for a script that does not do much work. We can assume that network communication consumed around 200 milliseconds, according to <code>curl</code> results.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; time curl -o /tmp/output "https://e.printstacktrace.blog"
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 23256    0 23256    0     0  23256      0 --:--:-- --:--:-- --:--:--  118k
curl -o /tmp/output "https://e.printstacktrace.blog"  0,02s user 0,01s system 10% cpu 0,206 total</code></pre></div></div><div class="paragraph"><p>It looks like that starting JVM and running Grape dependency manager takes around 1.5 seconds in this case. Let&#8217;s try to improve the performance by executing our script as a Java compiled class.</p></div></div></div><div class="sect1"><h2>Compiling script to Java bytecode</h2><div class="sectionbody"><div class="paragraph"><p>We need to explain one important thing. Grape dependency manager has some limitations<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>, and it does not work without Groovy class loader. There is a configuration annotation called <code>@GrabConfig(systemClassLoader = true)</code>, but it does not have any effect when we compile the script to a Java bytecode class file. A script containing this annotation generates the same bytecode as the one that misses it. If this annotation had any effect when running compiled bytecode as a Java program, then we could use <code>-Djava.system.class.loader</code> to specify the Groovy class loader.</p></div><div class="paragraph"><p>Here is the full Java command (with configured classpath) and the error Grape library throws because of the invalid class loader:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; java -Djava.system.class.loader=groovy.lang.GroovyClassLoader -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar:$HOME/.m2/repository/org/apache/ivy/ivy/2.4.0/ivy-2.4.0.jar" CountLinks https://e.printstacktrace.blog

Exception in thread "main" java.lang.ExceptionInInitializerError
Caused by: java.lang.RuntimeException: No suitable ClassLoader found for grab
	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
	...
	at org.codehaus.groovy.runtime.callsite.StaticMetaMethodSite.invoke(StaticMetaMethodSite.java:46)
	at org.codehaus.groovy.runtime.callsite.StaticMetaMethodSite.callStatic(StaticMetaMethodSite.java:102)
	at org.codehaus.groovy.runtime.callsite.CallSiteArray.defaultCallStatic(CallSiteArray.java:55)
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.callStatic(AbstractCallSite.java:197)
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.callStatic(AbstractCallSite.java:217)
	at CountLinks.&lt;clinit&gt;(CountLinks.groovy)</code></pre></div></div><div class="paragraph"><p>However, there is workaround we can apply. We can turn off Grape dependency manager with <code>-Dgroovy.grape.enabled=false</code> option and we can add Jsoup library JAR file to the classpath manually instead. Let&#8217;s give it a shot and see what happens.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -Dgroovy.grape.enable=false -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar:$HOME/.groovy/grapes/org.jsoup/jsoup/jars/jsoup-1.11.3.jar" CountLinks https://e.printstacktrace.blog

Website https://e.printstacktrace.blog contains 95 links.</code></pre></div></div><div class="paragraph"><p>In this case, we only added <code>groovy-all-2.5.2.jar</code> and <code>jsoup-1.11.3.jar</code> to execute the script successfully. Measuring execution time of the compiled Java program without Grape dependency manager shown that it takes around <strong>1 second</strong> in average to produce the same output as it was before. We still suffer from JVM boot time, but we can improve in this area as well. It&#8217;s time to create GraalVM native image.</p></div></div></div><div class="sect1"><h2>Creating GraalVM native image</h2><div class="sectionbody"><div class="paragraph"><p>Let&#8217;s use the existing CountLinks.class file to create a GraalVM native image from it. We need two JSON files containing reflection configuration for GraalVM. The first one <a href="https://gist.github.com/wololock/e99d748e724bf5ae6ce930c1b8cb9a90" target="_blank" rel="noopener">can be found here</a>, and it contains a configuration of all dynamically generated runtime methods for Groovy 2.5.2. The second one contains only Groovy script class we created.</p></div><div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content">You can also generate <code>dgm.json</code> file on your own <a href="https://gist.github.com/wololock/ac83a8196a8252fbbaacf4ac84e10b36" target="_blank" rel="noopener">using the following Groovy script</a>.</td></tr></table></div><div class="listingblock"><div class="title">Listing 2. src/countlinks.json</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name": "CountLinks",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  }
]</code></pre></div></div><div class="listingblock"><div class="title">Listing 3. Creating native image</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; native-image -Dgroovy.grape.enable=false \
    --enable-url-protocols=https \
    --allow-incomplete-classpath \
    -H:+AllowVMInspection \
    -H:+ReportUnsupportedElementsAtRuntime \
    -H:ReflectionConfigurationFiles=dgm.json,countlinks.json \
    --no-server \
    -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar:$HOME/.groovy/grapes/org.jsoup/jsoup/jars/jsoup-1.11.3.jar" \
    CountLinks

[countlinks:305]    classlist:   2,110.17 ms
[countlinks:305]        (cap):     998.28 ms
[countlinks:305]        setup:   2,746.31 ms
[countlinks:305]   (typeflow):  47,883.31 ms
[countlinks:305]    (objects): 107,634.87 ms
[countlinks:305]   (features):   1,475.31 ms
[countlinks:305]     analysis: 158,631.80 ms
[countlinks:305]     universe:   1,639.31 ms
[countlinks:305]      (parse):   5,070.39 ms
[countlinks:305]     (inline):   4,234.00 ms
[countlinks:305]    (compile):  34,543.96 ms
[countlinks:305]      compile:  46,402.57 ms
[countlinks:305]        image:  10,556.78 ms
[countlinks:305]        write:   1,365.01 ms
[countlinks:305]      [total]: 223,632.13 ms</code></pre></div></div><div class="paragraph"><p>The native image generation succeeds. Let&#8217;s run it.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./countlinks https://e.printstacktrace.blog

Exception in thread "main" groovy.lang.MissingMethodException: No signature of method: static org.codehaus.groovy.runtime.InvokerHelper.runScript() is applicable for argument types: (Class, [Ljava.lang.String;) values: [class CountLinks, [https://e.printstacktrace.blog]]
	at groovy.lang.MetaClassImpl.invokeStaticMissingMethod(MetaClassImpl.java:1528)
	at groovy.lang.MetaClassImpl.invokeStaticMethod(MetaClassImpl.java:1514)
	at org.codehaus.groovy.runtime.callsite.StaticMetaClassSite.call(StaticMetaClassSite.java:52)
	at org.codehaus.groovy.runtime.callsite.CallSiteArray.defaultCall(CallSiteArray.java:47)
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:116)
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:136)
	at CountLinks.main(CountLinks.groovy)</code></pre></div></div><div class="paragraph"><p>No luck. GraalVM throws this exception because at the current stage of the development<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> it is not possible to invoke any Groovy script class that is not statically compiled. Let&#8217;s fix it. We use compiler configuration script file named <code>compiler.groovy</code>. It adds static compilation and type checking.</p></div><div class="listingblock"><div class="title">Listing 4. src/compiler.groovy</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">withConfig(configuration) {
    ast(groovy.transform.CompileStatic)
    ast(groovy.transform.TypeChecked)
}</code></pre></div></div><div class="paragraph"><p>Let&#8217;s recompile the code using compiler configuration script.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; groovyc --configscript=compiler.groovy CountLinks.groovy

org.codehaus.groovy.control.MultipleCompilationErrorsException: startup failed:
CountLinks.groovy: 7: [Static type checking] - The variable [args] is undeclared.
 @ line 7, column 20.
   final String url = args[0]
                      ^

1 error</code></pre></div></div><div class="paragraph"><p>Bad luck. The error thrown by the static type checking says that there is no args variable available. We need to modify our initial script to make args variable available.</p></div><div class="listingblock"><div class="title">Listing 5. src/CountLinks.groovy</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">#!groovy
import org.jsoup.Jsoup
import org.jsoup.nodes.Document

@Grab(group='org.jsoup', module='jsoup', version='1.11.3')

final String[] args = getProperty("args") as String[]
final String url = args[0]

final Document doc = Jsoup.connect(url).get()
final int links = doc.select("a").size()
println "Website ${url} contains ${links} links."</code></pre></div></div><div class="paragraph"><p>Before we create a native image, let&#8217;s run this statically compiled Groovy script as a Java program to see if it makes any difference comparing to the previous example. It is not a bulletproof benchmark, but it looks like the new bytecode executes in around 830 milliseconds.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; time java -Dgroovy.grape.enable=false -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar:$HOME/.groovy/grapes/org.jsoup/jsoup/jars/jsoup-1.11.3.jar" CountLinks https://e.printstacktrace.blog
Website https://e.printstacktrace.blog contains 95 links.
java -Dgroovy.grape.enable=false -cp  CountLinks   2,59s user 0,13s system 330% cpu 0,823 total</code></pre></div></div><div class="paragraph"><p>Let&#8217;s recreate the native image.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; native-image -Dgroovy.grape.enable=false \
    --enable-url-protocols=https \
    --allow-incomplete-classpath \
    -H:+AllowVMInspection \
    -H:+ReportUnsupportedElementsAtRuntime \
    -H:ReflectionConfigurationFiles=dgm.json,countlinks.json \
    --no-server \
    -cp ".:$HOME/.m2/repository/org/codehaus/groovy/groovy/2.5.2/groovy-2.5.2.jar:$HOME/.groovy/grapes/org.jsoup/jsoup/jars/jsoup-1.11.3.jar" \
    CountLinks

[countlinks:17259]    classlist:   1,989.96 ms
[countlinks:17259]        (cap):     989.83 ms
[countlinks:17259]        setup:   2,380.31 ms
[countlinks:17259]   (typeflow):  42,717.13 ms
[countlinks:17259]    (objects): 105,959.35 ms
[countlinks:17259]   (features):   1,133.75 ms
[countlinks:17259]     analysis: 151,461.35 ms
[countlinks:17259]     universe:   1,489.67 ms
[countlinks:17259]      (parse):   4,564.73 ms
[countlinks:17259]     (inline):   4,501.88 ms
[countlinks:17259]    (compile):  33,623.14 ms
[countlinks:17259]      compile:  45,452.90 ms
[countlinks:17259]        image:   9,294.79 ms
[countlinks:17259]        write:     743.83 ms
[countlinks:17259]      [total]: 212,978.90 ms</code></pre></div></div><div class="paragraph"><p>And let&#8217;s run it.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">&gt; time ./countlinks https://e.printstacktrace.blog

WARNING: The sunec native library, required by the SunEC provider, could not be loaded. This library is usually shipped as part of the JDK and can be found under &lt;JAVA_HOME&gt;/jre/lib/&lt;platform&gt;/libsunec.so. It is loaded at run time via System.loadLibrary("sunec"), the first time services from SunEC are accessed. To use this provider's services the java.library.path system property needs to be set accordingly to point to a location that contains libsunec.so. Note that if java.library.path is not set it defaults to the current working directory.
Exception in thread "main" org.codehaus.groovy.runtime.InvokerInvocationException: java.lang.UnsatisfiedLinkError: sun.security.ec.ECDSASignature.verifySignedDigest([B[B[B[B)Z [symbol: Java_sun_security_ec_ECDSASignature_verifySignedDigest or Java_sun_security_ec_ECDSASignature_verifySignedDigest___3B_3B_3B_3B]
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:111)
	at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:326)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1235)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at org.codehaus.groovy.runtime.InvokerHelper.invokePogoMethod(InvokerHelper.java:1018)
	at org.codehaus.groovy.runtime.InvokerHelper.invokeMethod(InvokerHelper.java:1001)
	at org.codehaus.groovy.runtime.InvokerHelper.runScript(InvokerHelper.java:423)
	at CountLinks.main(CountLinks.groovy)
Caused by: java.lang.UnsatisfiedLinkError: sun.security.ec.ECDSASignature.verifySignedDigest([B[B[B[B)Z [symbol: Java_sun_security_ec_ECDSASignature_verifySignedDigest or Java_sun_security_ec_ECDSASignature_verifySignedDigest___3B_3B_3B_3B]
	at com.oracle.svm.jni.access.JNINativeLinkage.getOrFindEntryPoint(JNINativeLinkage.java:145)
	at com.oracle.svm.jni.JNIGeneratedMethodSupport.nativeCallAddress(JNIGeneratedMethodSupport.java:54)</code></pre></div></div><div class="paragraph"><p>Another error. We already used to it, right? :) This time the error we see is entirely expected. GraalVM does not support HTTPS protocol by default<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>, that is why we had to add <code>--enable-url-protocols=https</code>. However, the image we have built does not include required native library. It tries to load it, but it uses the current working directory, and it fails. The solution is simple - we need to add <code>-Djava.library.path</code> in the command line, and we are good to go.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; time ./countlinks -Djava.library.path=$JAVA_HOME/jre/lib/amd64 https://e.printstacktrace.blog
Website https://e.printstacktrace.blog contains 95 links.
./countlinks -Djava.library.path=$JAVA_HOME/jre/lib/amd64   0,02s user 0,01s system 18% cpu 0,196 total</code></pre></div></div><div class="paragraph"><p>Finally! <strong>It worked!</strong> Running the program several times shows that the average execution time is around <strong>200 ms</strong> (the best time recorded: <strong>151 ms</strong>). Our program is still affected by network latency, but this is something we cannot do anything with. However, we reduced the total execution time from <strong>1.7 s</strong> to <strong>0.2 s</strong>, using almost the same script (we only have to apply the changes required by static compilation).</p></div><script id="asciicast-Q4kI1S3hKDfTvGBOdgkAIAv0q" src="https://asciinema.org/a/Q4kI1S3hKDfTvGBOdgkAIAv0q.js" async></script></div></div><div class="sect1"><h2>Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>Groovy and Grape dependency management is a powerful pair of tools. And even if we can&#8217;t use Grape directly in the Java program, or we can&#8217;t invoke dynamic Groovy script in the GraalVM, we can still use almost the same bytecode and generate a standalone native image to remove the cost of the JVM boot and Grape dependency check.</p></div><div class="paragraph"><p>Of course, these benefits don&#8217;t come without a cost. The size of the generated native image is 50 MB, while the total size of the Groovy script and the two JAR dependencies it uses is around 5,6 MB. Also, the Groovy script you may want to compile to the native image might require some reworking to make it compatible with static compilation. So for some of the scripts, this might be not possible to do.</p></div><div class="paragraph"><p>I hope you&#8217;ve enjoyed reading this article and you&#8217;ve learned something useful from it. Please share your thoughts in the comments section below. I would love to hear your opinion.</p></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">Continue reading - <a href="/graalvm-native-image-inside-docker-container-does-it-make-sense/" title="GraalVM native image inside docker container - does it make sense?">GraalVM native image inside docker container - does it make sense?</a></td></tr></table></div></div></div><div id="footnotes"><hr><div class="footnote" id="_footnotedef_1"><a href="#_footnoteref_1">1</a>. <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md" class="bare" target="_blank" rel="noopener">https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md</a></div><div class="footnote" id="_footnotedef_2"><a href="#_footnoteref_2">2</a>. <a href="https://github.com/oracle/graal/issues/708" class="bare" target="_blank" rel="noopener">https://github.com/oracle/graal/issues/708</a></div><div class="footnote" id="_footnotedef_3"><a href="#_footnoteref_3">3</a>. <a href="https://github.com/oracle/graal/blob/master/substratevm/URL-PROTOCOLS.md#https-support" class="bare" target="_blank" rel="noopener">https://github.com/oracle/graal/blob/master/substratevm/URL-PROTOCOLS.md#https-support</a></div></div><section class="post-tags"><a href="/tags/groovy/" class="tag post-meta">#groovy</a><a href="/tags/graalvm/" class="tag post-meta">#graalvm</a><a href="/tags/grape/" class="tag post-meta">#grape</a><a href="/tags/native-image/" class="tag post-meta">#native-image</a></section><footer class="post-footer"><img src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200" class="img-responsive img-circle"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Szymon Stepniak</h4><p>Groovista, Upwork's Top Rated freelancer, Toruń Java User Group founder, open&nbsp;source contributor, Stack Overflow addict, bedroom guitar player. I walk through e.printStackTrace() so you don't have to.</p><ul class="social-links"><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/channel/UCEf8e5YAYnowq-2deW4tpsw/featured" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/graalvm-native-image-inside-docker-container-does-it-make-sense/"><img src="/images/og/graalvm-docker-groovy.jpg" class="img-responsive"><h3>GraalVM native image inside docker container - does it make sense?</h3></a><p>We have learned how to create GraalVM native image from standalone Groovy script in the previous blog post. Today we continue the experiments, and this time we are going to create a Docker image to...</p></div><div class="col-lg-4"><a href="/graalvm-and-groovy-how-to-start/"><img src="/images/og/graalvm-groovy-how-to-start2.jpg" class="img-responsive"><h3>GraalVM and Groovy - how to start?</h3></a><p>GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smal...</p></div><div class="col-lg-4"><a href="/ratpack-graalvm-how-to-start/"><img src="/images/og/ratpack-graalvm-how-to-start.jpg" class="img-responsive"><h3>Ratpack on GraalVM - how to start?</h3></a><p>The journey inside the exciting world of GraalVM continues. Today I would like to share with you results of running Ratpack on GraalVM experiment. You are going to learn how to build a native binar...</p></div></div></section></article><nav role="pagination" class="pagination"><a href="/graalvm-native-image-inside-docker-container-does-it-make-sense/" class="pull-left btn">← Next post</a><a href="/deep-work-book-review/" class="pull-right btn">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"></div></div></div><script>var url_parts=window.location.href.split("?"),disqus_url=url_parts[0];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//eprintstacktrace.disqus.com/embed.js",(document.head||d.body).appendChild(t)}()</script></div></div></div><script id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><footer class="site-footer"><div class="container-fluid"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1"><div class="row"><div class="col-lg-4"><h4>e.printstacktrace.blog © 2019</h4><p><em>"I walk through e.printStackTrace() so you don't have to"</em></p><p><a href="/privacy-policy/">Privacy policy</a></p><p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a></p></div><div class="col-lg-4"><h4 class="marked">Recent articles</h4><section class="recent-posts"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/gr8conf-eu-2019-recap/">GR8Conf EU 2019 Recap</a></li><li class="post-list-item"><a class="post-list-link" href="/gr8conf-eu-2019-what-can-you-expect-from-my-talks/">GR8Conf EU 2019 - what can you expect from my talks?</a></li><li class="post-list-item"><a class="post-list-link" href="/debugging-teams-book-review/">Debugging Teams - book review</a></li><li class="post-list-item"><a class="post-list-link" href="/spock-random-order-of-tests-how-to/">Spock random order of tests - how to?</a></li><li class="post-list-item"><a class="post-list-link" href="/graalvm-heap-size-of-native-image-how-to-set-it/">GraalVM and heap size of the native image - how to set it?</a></li><li class="post-list-item"><a class="post-list-link" href="/using-the-same-prefix-with-different-http-methods-in-ratpack/">Using the same prefix with different HTTP methods in Ratpack</a></li></ul></section></div><div class="col-lg-4"><h4 class="marked">Stay connected</h4><div class="social-links"><ul><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/channel/UCEf8e5YAYnowq-2deW4tpsw/featured" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div><h4 class="marked">Most popular tags</h4><section class="tagcloud"><a href="/tags/async/" style="font-size:12pt;color:#777">async</a> <a href="/tags/book/" style="font-size:20pt;color:#929292">book</a> <a href="/tags/career/" style="font-size:8pt;color:#6a6a6a">career</a> <a href="/tags/graalvm/" style="font-size:24pt;color:#9f9f9f">graalvm</a> <a href="/tags/grails/" style="font-size:8pt;color:#6a6a6a">grails</a> <a href="/tags/groovy/" style="font-size:32pt;color:#bababa">groovy</a> <a href="/tags/haskell/" style="font-size:12pt;color:#777">haskell</a> <a href="/tags/java/" style="font-size:28pt;color:#adadad">java</a> <a href="/tags/java-8/" style="font-size:12pt;color:#777">java-8</a> <a href="/tags/jmh/" style="font-size:16pt;color:#858585">jmh</a> <a href="/tags/junit/" style="font-size:12pt;color:#777">junit</a> <a href="/tags/learning/" style="font-size:12pt;color:#777">learning</a> <a href="/tags/micronaut/" style="font-size:16pt;color:#858585">micronaut</a> <a href="/tags/native-image/" style="font-size:16pt;color:#858585">native-image</a> <a href="/tags/non-blocking/" style="font-size:16pt;color:#858585">non-blocking</a> <a href="/tags/progress/" style="font-size:8pt;color:#6a6a6a">progress</a> <a href="/tags/ratpack/" style="font-size:24pt;color:#9f9f9f">ratpack</a> <a href="/tags/reactive-programming/" style="font-size:12pt;color:#777">reactive-programming</a> <a href="/tags/reading/" style="font-size:12pt;color:#777">reading</a> <a href="/tags/review/" style="font-size:20pt;color:#929292">review</a> <a href="/tags/rxjava/" style="font-size:12pt;color:#777">rxjava</a> <a href="/tags/spock/" style="font-size:16pt;color:#858585">spock</a> <a href="/tags/stackoverflow/" style="font-size:12pt;color:#777">stackoverflow</a> <a href="/tags/testing/" style="font-size:8pt;color:#6a6a6a">testing</a> <a href="/tags/unit-test/" style="font-size:16pt;color:#858585">unit-test</a></section></div></div></div></div></div><section class="poweredby"><ul class="text-center"><li><span>Published with </span><a href="https://hexo.io" onclick="return window.open(this.href),!1"><img src="/img/logo-hexo.png"></a></li><li><span>Hosted on </span><a href="https://github.com/wololock/wololock.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-github.png"></a></li><li><span>Deployed with </span><a href="https://travis-ci.org/wololock/wololock.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-travis.png"></a></li></ul></section></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="1.6rem" data-bg="#444"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,n,o,t,c,g){a.GoogleAnalyticsObject=t,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(n),g=e.getElementsByTagName(n)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",g.parentNode.insertBefore(c,g)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"))</script></body></html>